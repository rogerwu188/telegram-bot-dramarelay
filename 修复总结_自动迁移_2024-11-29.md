# Telegram Bot ä¿®å¤æ€»ç»“ - è‡ªåŠ¨æ•°æ®åº“è¿ç§»

**ä¿®å¤æ—¥æœŸ**: 2024å¹´11æœˆ29æ—¥  
**æäº¤å“ˆå¸Œ**: 31a0c3e  
**GitHubä»“åº“**: https://github.com/rogerwu188/telegram-bot-dramarelay  
**éƒ¨ç½²å¹³å°**: Railway (https://web-production-b95cb.up.railway.app)

---

## é—®é¢˜æè¿°

ç”¨æˆ·åœ¨Railwayæ§åˆ¶å°ä¸­æ‰¾ä¸åˆ°Shellæˆ–Run CommandåŠŸèƒ½ï¼Œæ— æ³•æ‰‹åŠ¨è¿è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬ `migrate_invitation_system.py`ã€‚

---

## è§£å†³æ–¹æ¡ˆ

æ·»åŠ è‡ªåŠ¨æ•°æ®åº“è¿ç§»åŠŸèƒ½ï¼Œè®©Botåœ¨å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æŸ¥å¹¶åˆ›å»ºé‚€è¯·ç³»ç»Ÿæ‰€éœ€çš„è¡¨å’Œå­—æ®µã€‚

---

## å®ç°ç»†èŠ‚

### 1. æ–°å¢ auto_migrate() å‡½æ•°

åœ¨ `bot.py` ä¸­æ·»åŠ äº† `auto_migrate()` å‡½æ•°ï¼ˆç¬¬77-194è¡Œï¼‰ï¼Œè¯¥å‡½æ•°ä¼šï¼š

#### æ­¥éª¤1ï¼šæ£€æŸ¥ users è¡¨å­—æ®µ

```python
# æ£€æŸ¥ users è¡¨æ˜¯å¦æœ‰ invited_by å­—æ®µ
cur.execute("""
    SELECT column_name 
    FROM information_schema.columns 
    WHERE table_name='users' AND column_name='invited_by'
""")
has_invited_by = cur.fetchone() is not None
```

å¦‚æœå­—æ®µä¸å­˜åœ¨ï¼Œåˆ™æ·»åŠ ï¼š
- `invited_by`ï¼šè®°å½•è¢«è°é‚€è¯·
- `invitation_reward_received`ï¼šæ˜¯å¦å·²é¢†å–æ–°äººå¥–åŠ±
- `invitation_reward_received_at`ï¼šé¢†å–æ—¶é—´

#### æ­¥éª¤2ï¼šæ£€æŸ¥å¹¶åˆ›å»º user_invitations è¡¨

```python
# æ£€æŸ¥ user_invitations è¡¨æ˜¯å¦å­˜åœ¨
cur.execute("""
    SELECT EXISTS (
        SELECT FROM information_schema.tables 
        WHERE table_name = 'user_invitations'
    )
""")
has_invitations_table = cur.fetchone()['exists']

if not has_invitations_table:
    # åˆ›å»ºè¡¨...
```

#### æ­¥éª¤3ï¼šæ£€æŸ¥å¹¶åˆ›å»º referral_rewards è¡¨

ç±»ä¼¼åœ°æ£€æŸ¥å¹¶åˆ›å»º `referral_rewards` è¡¨ã€‚

#### æ­¥éª¤4ï¼šåŒæ­¥å·²æœ‰æ•°æ®

å¦‚æœ `users` è¡¨ä¸­å·²æœ‰ `invited_by` æ•°æ®ï¼Œä½† `user_invitations` è¡¨åˆšåˆ›å»ºï¼Œåˆ™åŒæ­¥æ•°æ®ï¼š

```python
if not has_invitations_table and has_invited_by:
    cur.execute("""
        INSERT INTO user_invitations (inviter_id, invitee_id, created_at)
        SELECT invited_by, user_id, created_at
        FROM users
        WHERE invited_by IS NOT NULL
        ON CONFLICT (invitee_id) DO NOTHING
    """)
```

### 2. åœ¨ main() å‡½æ•°ä¸­è°ƒç”¨

åœ¨ `main()` å‡½æ•°çš„å¼€å§‹éƒ¨åˆ†ï¼ˆç¬¬2415-2416è¡Œï¼‰è°ƒç”¨ `auto_migrate()`ï¼š

```python
def main():
    """ä¸»å‡½æ•°"""
    logger.info("ğŸš€ X2C DramaRelayBot Starting...")
    
    # è¿è¡Œæ•°æ®åº“è¿ç§»
    logger.info("ğŸ”§ Running database migrations...")
    auto_migrate()
    
    # åˆå§‹åŒ–æ•°æ®åº“
    init_database()
    
    # ... å…¶ä»–ä»£ç 
```

---

## å·¥ä½œæµç¨‹

### Botå¯åŠ¨æ—¶çš„æ‰§è¡Œé¡ºåº

1. **å¯åŠ¨æ—¥å¿—**ï¼š`ğŸš€ X2C DramaRelayBot Starting...`
2. **è¿è¡Œè¿ç§»**ï¼š`ğŸ”§ Running database migrations...`
3. **æ£€æŸ¥è¿ç§»**ï¼š`ğŸ”„ æ£€æŸ¥æ•°æ®åº“è¿ç§»...`
4. **æ‰§è¡Œè¿ç§»**ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼š
   - `ğŸ“ æ·»åŠ é‚€è¯·ç³»ç»Ÿå­—æ®µåˆ° users è¡¨...`
   - `âœ… users è¡¨å­—æ®µå·²æ·»åŠ `
   - `ğŸ“ åˆ›å»º user_invitations è¡¨...`
   - `âœ… user_invitations è¡¨å·²åˆ›å»º`
   - `ğŸ“ åˆ›å»º referral_rewards è¡¨...`
   - `âœ… referral_rewards è¡¨å·²åˆ›å»º`
   - `ğŸ“ åŒæ­¥å·²æœ‰é‚€è¯·å…³ç³»...`
   - `âœ… å·²åŒæ­¥ X æ¡é‚€è¯·å…³ç³»`
5. **è¿ç§»å®Œæˆ**ï¼š`âœ… æ•°æ®åº“è¿ç§»å®Œæˆ`
6. **åˆå§‹åŒ–æ•°æ®åº“**ï¼š`Initializing database...`
7. **Botå¯åŠ¨å®Œæˆ**

### åç»­å¯åŠ¨

å¦‚æœè¡¨å’Œå­—æ®µå·²ç»å­˜åœ¨ï¼Œ`auto_migrate()` ä¼šå¿«é€Ÿæ£€æŸ¥å¹¶è·³è¿‡ï¼Œä¸ä¼šé‡å¤åˆ›å»ºã€‚

---

## ä¼˜åŠ¿

### 1. æ— éœ€æ‰‹åŠ¨æ“ä½œ

- âœ… éƒ¨ç½²åè‡ªåŠ¨è¿è¡Œè¿ç§»
- âœ… æ— éœ€è®¿é—®Railwayæ§åˆ¶å°
- âœ… æ— éœ€å®‰è£…Railway CLI
- âœ… æ— éœ€æ‰‹åŠ¨æ‰§è¡Œè„šæœ¬

### 2. å¹‚ç­‰æ€§

- âœ… å¤šæ¬¡è¿è¡Œä¸ä¼šå‡ºé”™
- âœ… å·²å­˜åœ¨çš„è¡¨å’Œå­—æ®µä¼šè¢«è·³è¿‡
- âœ… ä¸ä¼šé‡å¤æ’å…¥æ•°æ®

### 3. å®‰å…¨æ€§

- âœ… ä½¿ç”¨ `IF NOT EXISTS` å’Œ `ON CONFLICT` é¿å…å†²çª
- âœ… äº‹åŠ¡å¤„ç†ï¼Œå¤±è´¥æ—¶è‡ªåŠ¨å›æ»š
- âœ… è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

### 4. å¯ç»´æŠ¤æ€§

- âœ… ä»£ç é›†ä¸­åœ¨ `bot.py` ä¸­
- âœ… æ˜“äºæ·»åŠ æ–°çš„è¿ç§»é€»è¾‘
- âœ… æ—¥å¿—æ¸…æ™°ï¼Œä¾¿äºè°ƒè¯•

---

## éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤1ï¼šæ¨é€ä»£ç 

```bash
git add bot.py
git commit -m "feat: æ·»åŠ è‡ªåŠ¨æ•°æ®åº“è¿ç§»åŠŸèƒ½"
git push origin main
```

### æ­¥éª¤2ï¼šç­‰å¾…Railwayè‡ªåŠ¨éƒ¨ç½²

Railwayä¼šè‡ªåŠ¨æ£€æµ‹ä»£ç å˜æ›´å¹¶é‡æ–°éƒ¨ç½²ï¼ˆçº¦2-3åˆ†é’Ÿï¼‰ã€‚

### æ­¥éª¤3ï¼šæ£€æŸ¥éƒ¨ç½²æ—¥å¿—

åœ¨Railwayæ§åˆ¶å°çš„ "Logs" æ ‡ç­¾é¡µä¸­ï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ï¼š

```
ğŸš€ X2C DramaRelayBot Starting...
ğŸ”§ Running database migrations...
ğŸ”„ æ£€æŸ¥æ•°æ®åº“è¿ç§»...
ğŸ“ æ·»åŠ é‚€è¯·ç³»ç»Ÿå­—æ®µåˆ° users è¡¨...
âœ… users è¡¨å­—æ®µå·²æ·»åŠ 
ğŸ“ åˆ›å»º user_invitations è¡¨...
âœ… user_invitations è¡¨å·²åˆ›å»º
ğŸ“ åˆ›å»º referral_rewards è¡¨...
âœ… referral_rewards è¡¨å·²åˆ›å»º
âœ… æ•°æ®åº“è¿ç§»å®Œæˆ
Initializing database...
âœ… Database tables initialized successfully
```

### æ­¥éª¤4ï¼šæµ‹è¯•é‚€è¯·åŠŸèƒ½

1. åœ¨Botä¸­ç‚¹å‡»"ç©ºæŠ•å¥–åŠ±"æŒ‰é’®
2. æ£€æŸ¥é‚€è¯·ç»Ÿè®¡æ˜¯å¦æ­£å¸¸æ˜¾ç¤º
3. åˆ†äº«é‚€è¯·é“¾æ¥ç»™å¥½å‹æµ‹è¯•

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯1ï¼šé¦–æ¬¡éƒ¨ç½²ï¼ˆè¡¨ä¸å­˜åœ¨ï¼‰

**é¢„æœŸç»“æœ**ï¼š
- âœ… è‡ªåŠ¨åˆ›å»ºæ‰€æœ‰è¡¨å’Œå­—æ®µ
- âœ… é‚€è¯·ç»Ÿè®¡æ˜¾ç¤º"å·²é‚€è¯·äººæ•°ï¼š0 äºº"
- âœ… Botæ­£å¸¸å¯åŠ¨

### æµ‹è¯•åœºæ™¯2ï¼šå·²æœ‰è¡¨ï¼ˆé‡å¤éƒ¨ç½²ï¼‰

**é¢„æœŸç»“æœ**ï¼š
- âœ… å¿«é€Ÿæ£€æŸ¥å¹¶è·³è¿‡å·²å­˜åœ¨çš„è¡¨
- âœ… ä¸ä¼šæŠ¥é”™
- âœ… Botæ­£å¸¸å¯åŠ¨

### æµ‹è¯•åœºæ™¯3ï¼šéƒ¨åˆ†è¡¨å­˜åœ¨

**é¢„æœŸç»“æœ**ï¼š
- âœ… åªåˆ›å»ºç¼ºå¤±çš„è¡¨å’Œå­—æ®µ
- âœ… åŒæ­¥å·²æœ‰æ•°æ®
- âœ… Botæ­£å¸¸å¯åŠ¨

---

## ä¸ä¹‹å‰çš„åŒºåˆ«

### ä¹‹å‰çš„æ–¹æ¡ˆ

1. æ¨é€ä»£ç åˆ°GitHub
2. ç­‰å¾…Railwayéƒ¨ç½²
3. **æ‰‹åŠ¨åœ¨Railwayæ§åˆ¶å°è¿è¡Œ `python3 migrate_invitation_system.py`**
4. é‡å¯Bot

**é—®é¢˜**ï¼š
- âŒ éœ€è¦æ‰¾åˆ°Railwayçš„ShellåŠŸèƒ½
- âŒ éœ€è¦æ‰‹åŠ¨æ‰§è¡Œå‘½ä»¤
- âŒ å®¹æ˜“å¿˜è®°æ‰§è¡Œè¿ç§»

### ç°åœ¨çš„æ–¹æ¡ˆ

1. æ¨é€ä»£ç åˆ°GitHub
2. ç­‰å¾…Railwayéƒ¨ç½²
3. **Botè‡ªåŠ¨è¿è¡Œè¿ç§»**
4. Botè‡ªåŠ¨å¯åŠ¨

**ä¼˜åŠ¿**ï¼š
- âœ… å®Œå…¨è‡ªåŠ¨åŒ–
- âœ… é›¶æ‰‹åŠ¨æ“ä½œ
- âœ… ä¸ä¼šå¿˜è®°è¿ç§»

---

## æ³¨æ„äº‹é¡¹

### 1. è¿ç§»è„šæœ¬ä»ç„¶ä¿ç•™

`migrate_invitation_system.py` è„šæœ¬ä»ç„¶ä¿ç•™åœ¨é¡¹ç›®ä¸­ï¼Œå¯ä»¥ç”¨äºï¼š
- æ‰‹åŠ¨è§¦å‘è¿ç§»ï¼ˆå¦‚æœéœ€è¦ï¼‰
- ç‹¬ç«‹æµ‹è¯•è¿ç§»é€»è¾‘
- åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒè¿è¡Œ

### 2. æ•°æ®åº“æƒé™

ç¡®ä¿Botçš„æ•°æ®åº“ç”¨æˆ·æœ‰ä»¥ä¸‹æƒé™ï¼š
- `ALTER TABLE`ï¼šæ·»åŠ å­—æ®µ
- `CREATE TABLE`ï¼šåˆ›å»ºè¡¨
- `INSERT`ï¼šåŒæ­¥æ•°æ®
- `SELECT`ï¼šæŸ¥è¯¢è¡¨ç»“æ„

Railwayçš„é»˜è®¤é…ç½®å·²åŒ…å«è¿™äº›æƒé™ã€‚

### 3. è¿ç§»å¤±è´¥å¤„ç†

å¦‚æœè¿ç§»å¤±è´¥ï¼š
- Botä¼šè®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- äº‹åŠ¡ä¼šè‡ªåŠ¨å›æ»šï¼Œä¸ä¼šç ´åæ•°æ®
- Botä¼šç»§ç»­å¯åŠ¨ï¼ˆä½¿ç”¨ç°æœ‰è¡¨ç»“æ„ï¼‰

æ‚¨å¯ä»¥åœ¨Railwayçš„Logsä¸­æŸ¥çœ‹é”™è¯¯ä¿¡æ¯ã€‚

---

## åç»­ä¼˜åŒ–å»ºè®®

### 1. ç‰ˆæœ¬åŒ–è¿ç§»

è€ƒè™‘æ·»åŠ è¿ç§»ç‰ˆæœ¬ç®¡ç†ï¼š

```python
def get_migration_version():
    """è·å–å½“å‰è¿ç§»ç‰ˆæœ¬"""
    cur.execute("SELECT version FROM schema_migrations ORDER BY version DESC LIMIT 1")
    result = cur.fetchone()
    return result['version'] if result else 0

def apply_migration_v2():
    """åº”ç”¨ç‰ˆæœ¬2çš„è¿ç§»"""
    # æ–°çš„è¿ç§»é€»è¾‘...
```

### 2. è¿ç§»å†å²è®°å½•

åˆ›å»º `schema_migrations` è¡¨è®°å½•è¿ç§»å†å²ï¼š

```sql
CREATE TABLE schema_migrations (
    version INTEGER PRIMARY KEY,
    applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3. å›æ»šåŠŸèƒ½

æ·»åŠ è¿ç§»å›æ»šåŠŸèƒ½ï¼š

```python
def rollback_migration_v2():
    """å›æ»šç‰ˆæœ¬2çš„è¿ç§»"""
    # å›æ»šé€»è¾‘...
```

---

## ç›¸å…³é“¾æ¥

- **GitHubæäº¤**: https://github.com/rogerwu188/telegram-bot-dramarelay/commit/31a0c3e
- **ä¸Šä¸€æ¬¡ä¿®å¤**: 8a9e3c8 (æ·»åŠ é‚€è¯·ç³»ç»Ÿæ•°æ®åº“è¡¨ç»“æ„)
- **Railwayéƒ¨ç½²**: https://web-production-b95cb.up.railway.app

---

## ä¿®å¤å†å²

1. **ad22b72**: ä¿®å¤è¿”å›æŒ‰é’®å“åº”æ…¢å’Œæäº¤ä»»åŠ¡æç¤ºæ–‡æ¡ˆä¸å®Œæ•´çš„é—®é¢˜
2. **d36dc02**: ä¿®å¤æäº¤é“¾æ¥æ— å“åº”é—®é¢˜ï¼ˆkeywordsä¸ºç©ºå¯¼è‡´å¼‚å¸¸ï¼‰
3. **2d7fbba**: ä¿®å¤æ•°æ®åº“å­—æ®µåé”™è¯¯
4. **8a9e3c8**: æ·»åŠ é‚€è¯·ç³»ç»Ÿæ•°æ®åº“è¡¨ç»“æ„
5. **31a0c3e**: æ·»åŠ è‡ªåŠ¨æ•°æ®åº“è¿ç§»åŠŸèƒ½ï¼ˆæœ¬æ¬¡ä¿®å¤ï¼‰

---

**ä¿®å¤å®Œæˆ** âœ…

**ä¸‹ä¸€æ­¥**ï¼šç­‰å¾…Railwayéƒ¨ç½²å®Œæˆï¼Œæ£€æŸ¥æ—¥å¿—ç¡®è®¤è¿ç§»æˆåŠŸï¼Œç„¶åæµ‹è¯•é‚€è¯·åŠŸèƒ½ï¼
