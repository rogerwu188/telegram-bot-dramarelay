# X2C Telegram Bot - 点赞数据来源调查报告

**调查日期**：2025年11月29日  
**调查对象**：TGBotDistribute (X2C 流量节点 Telegram Bot)  
**调查目的**：确认点赞数（like_count）和播放量数据的来源

---

## 一、调查结论

**Bot 本身不提供点赞数和播放量数据。**

经过对 Bot 全部源代码的详细检查，我可以明确确认：

1. **Bot 不采集点赞数**：代码中没有任何逻辑用于从 TikTok、YouTube 等平台抓取点赞数或播放量
2. **Bot 不存储点赞数**：数据库中没有存储点赞数或播放量的字段
3. **Bot 不上报点赞数**：Webhook 回调中不包含点赞数或播放量字段

---

## 二、Bot 实际功能

### 2.1 Bot 的核心职责

Bot 作为一个**任务分发和验证节点**，其核心功能包括：

1. **任务分发**：向用户分发短剧视频任务
2. **链接验证**：验证用户提交的视频链接是否真实可访问
3. **内容匹配**：检查视频内容是否与任务要求匹配
4. **事件上报**：将任务完成事件通过 Webhook 上报给后端系统

### 2.2 Bot 上报的数据字段

根据 `webhook_notifier.py` 的代码分析，Bot 通过 Webhook 上报的数据结构如下：

```json
{
  "event": "task.completed",
  "timestamp": "2025-11-29T23:00:00.000Z",
  "data": {
    "task_id": 1,
    "task_title": "短剧片段 · 《ruthless-kindness》",
    "user_id": 123456789,
    "username": "test_user",
    "platform": "tiktok",
    "submission_link": "https://www.tiktok.com/@user/video/123456",
    "submitted_at": "2025-11-29T22:55:00.000Z",
    "verified_at": "2025-11-29T23:00:00.000Z",
    "node_power_earned": 10,
    "verification_status": "verified",
    "verification_details": {
      "success": true,
      "matched": true,
      "page_title": "视频标题",
      "page_text": "视频描述和标签内容",
      "screenshot_path": "/tmp/screenshots/verify_20251129_230000.png"
    }
  }
}
```

**关键观察**：
- ✅ 包含：任务ID、用户ID、平台、提交链接、验证状态、页面标题、描述文本
- ❌ **不包含**：点赞数、播放量、评论数、分享数等社交媒体统计数据

---

## 三、验证详情 (verification_details) 的内容

Bot 的 `link_verifier.py` 模块负责验证链接，其返回的 `verification_details` 包含以下字段：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `success` | Boolean | 验证是否成功（链接可访问） |
| `matched` | Boolean | 内容是否匹配任务要求 |
| `page_title` | String | 页面标题 |
| `page_text` | String | 视频描述和标签文本 |
| `screenshot_path` | String | 验证截图路径 |
| `error` | String | 错误信息（如果有） |

**验证逻辑**：
1. 使用 Playwright 浏览器自动化访问用户提交的链接
2. 提取页面标题、视频描述、标签（hashtags）
3. 检查描述和标签是否包含任务关键词
4. 保存页面截图作为验证凭证
5. **不提取任何社交媒体统计数据**

---

## 四、点赞数据的实际来源

根据您提供的截图，`project_site_stats` 表中的点赞数（920）和播放量（15,680）数据来源应该是：

### 4.1 后端系统的二次处理

Bot 上报任务完成事件后，**后端系统**（接收 Webhook 的服务）会进行以下处理：

1. **接收 Bot 上报的事件**：包含 `submission_link`（视频链接）
2. **调用第三方 API 或爬虫**：使用视频链接从 TikTok/YouTube API 获取统计数据
3. **存储到数据库**：将获取的点赞数、播放量等数据存入 `project_site_stats` 表

### 4.2 可能的数据获取方式

后端系统可能通过以下方式获取点赞数和播放量：

| 方式 | 说明 | 优点 | 缺点 |
|------|------|------|------|
| **官方 API** | TikTok/YouTube 官方数据接口 | 数据准确、稳定 | 需要申请权限、有调用限制 |
| **第三方 API** | RapidAPI、Apify 等服务 | 易于集成 | 需要付费、可能不稳定 |
| **网页爬虫** | 使用 Playwright/Selenium 抓取 | 灵活、无需权限 | 容易被封禁、维护成本高 |
| **定时轮询** | 定期访问链接更新数据 | 可追踪数据变化 | 延迟较高、资源消耗大 |

---

## 五、数据流程图

```
用户提交视频链接
       ↓
Bot 验证链接真实性和内容匹配度
       ↓
Bot 通过 Webhook 上报事件
   {
     submission_link: "https://tiktok.com/..."
     verification_status: "verified"
     ...
   }
       ↓
后端系统接收 Webhook
       ↓
后端系统使用 submission_link 调用 TikTok API
       ↓
获取点赞数、播放量等统计数据
       ↓
存储到 project_site_stats 表
   {
     like_count: 920
     view_count: 15680
     ...
   }
```

---

## 六、代码证据

### 6.1 Webhook 回调代码（webhook_notifier.py 第 188-204 行）

```python
payload = {
    'event': 'task.completed',
    'timestamp': datetime.utcnow().isoformat() + 'Z',
    'data': {
        'task_id': task_id,
        'task_title': task['title'],
        'user_id': user_id,
        'username': username,
        'platform': platform,
        'submission_link': submission_link,  # ← 只上报链接
        'submitted_at': submission['submitted_at'].isoformat() + 'Z',
        'verified_at': submission['verified_at'].isoformat() + 'Z',
        'node_power_earned': node_power_earned,
        'verification_status': 'verified',
        'verification_details': verification_details or {}  # ← 不包含点赞数
    }
}
```

### 6.2 验证详情代码（link_verifier.py 第 90-97 行）

```python
result = {
    'success': False,
    'matched': False,
    'screenshot_path': None,
    'page_title': '',      # ← 只提取标题
    'page_text': '',       # ← 只提取描述和标签
    'error': None
}
# 没有 like_count、view_count 等字段
```

### 6.3 全代码搜索结果

对所有 `.py` 文件进行关键词搜索：
- 搜索 `like`：只找到 User-Agent 中的 "like Gecko"
- 搜索 `点赞`：无结果
- 搜索 `播放`：无结果
- 搜索 `view_count`：无结果
- 搜索 `like_count`：无结果

---

## 七、最终结论

**Bot 不提供点赞数和播放量数据。**

您在 `project_site_stats` 表中看到的点赞数（920）和播放量（15,680）是由**后端系统**在接收到 Bot 的 Webhook 回调后，通过以下方式获取的：

1. Bot 上报 `submission_link`（视频链接）
2. 后端系统使用该链接调用 TikTok/YouTube API 或爬虫
3. 后端系统获取点赞数、播放量等统计数据
4. 后端系统将数据存入 `project_site_stats` 表

**Bot 的职责**：验证链接真实性和内容匹配度，上报任务完成事件  
**后端系统的职责**：获取社交媒体统计数据，进行数据分析和存储

---

## 八、建议

如果您需要 Bot 直接提供点赞数和播放量数据，需要进行以下改造：

1. **集成第三方 API**：在 Bot 中集成 TikTok/YouTube 数据 API
2. **修改验证模块**：在 `link_verifier.py` 中添加数据抓取逻辑
3. **更新 Webhook 数据结构**：在回调数据中添加 `like_count`、`view_count` 等字段
4. **考虑性能影响**：API 调用会增加验证时间，可能需要异步处理

**是否需要我实现这个功能？**
