# Telegram Bot 修复总结 - 数据库字段错误

**修复日期**: 2024年11月29日  
**提交哈希**: 2d7fbba  
**GitHub仓库**: https://github.com/rogerwu188/telegram-bot-dramarelay  
**部署平台**: Railway (https://web-production-b95cb.up.railway.app)

---

## 问题描述

用户点击"提交链接"按钮后，Bot抛出数据库字段不存在的错误：

```
psycopg2.errors.UndefinedColumn: column dt.keywords does not exist
LINE 2: ...T dt.title, dt.node_power_reward, dt.description, dt.keyword...
```

---

## 问题分析

### 根本原因

在之前的修复中（提交 d36dc02），我将SQL查询从：

```sql
SELECT dt.title, dt.node_power_reward, dt.video_title, dt.task_template, dt.keywords_template
```

改为：

```sql
SELECT dt.title, dt.node_power_reward, dt.description, dt.keywords
```

但是数据库表 `drama_tasks` 中实际存在的字段是：
- `task_template`（而不是 `description`）
- `keywords_template`（而不是 `keywords`）

或者根据最初的表结构定义，这些字段都不存在，只有基本字段：
- task_id
- title
- description
- video_file_id
- thumbnail_url
- duration
- node_power_reward
- platform_requirements
- status
- created_at

### 数据库表结构不一致

代码中引用了 `task_template` 和 `keywords_template` 字段，但这些字段在 CREATE TABLE 语句中并未定义。这说明：

1. 数据库表结构在运行时被手动修改过（添加了新字段）
2. 或者代码和数据库不同步

---

## 修复方案

### 1. 使用 SELECT * 查询所有字段

将SQL查询改为 `SELECT dt.*`，这样无论数据库中有哪些字段都能获取到：

```sql
SELECT dt.*
FROM user_tasks ut
JOIN drama_tasks dt ON ut.task_id = dt.task_id
WHERE ut.user_id = %s AND ut.task_id = %s
```

### 2. 兼容不同的字段名

在获取字段值时，使用 `or` 运算符兼容不同的字段名：

```python
# 兼容不同的字段名：description 或 task_template
description = task.get('description') or task.get('task_template', '') or ''

# 兼容不同的字段名：keywords 或 keywords_template
keywords_raw = task.get('keywords') or task.get('keywords_template', '') or ''
```

这样无论数据库中使用哪个字段名，代码都能正常工作。

---

## 修改详情

### 修改文件
- `bot.py`

### 修改位置

#### 1. submit_task_select_callback 函数（第1390-1395行）

**修改前**：
```python
cur.execute("""
    SELECT dt.title, dt.node_power_reward, dt.description, dt.keywords
    FROM user_tasks ut
    JOIN drama_tasks dt ON ut.task_id = dt.task_id
    WHERE ut.user_id = %s AND ut.task_id = %s
""", (user_id, task_id))
```

**修改后**：
```python
cur.execute("""
    SELECT dt.*
    FROM user_tasks ut
    JOIN drama_tasks dt ON ut.task_id = dt.task_id
    WHERE ut.user_id = %s AND ut.task_id = %s
""", (user_id, task_id))
```

#### 2. 字段获取逻辑（第1412-1417行）

**修改前**：
```python
title = task.get('title', '')
description = task.get('description', '')
keywords_raw = task.get('keywords', '') or ''
reward = task.get('node_power_reward', 0)

# 确保 description 不为 None
if description is None:
    description = ''
```

**修改后**：
```python
title = task.get('title', '')
# 兼容不同的字段名：description 或 task_template
description = task.get('description') or task.get('task_template', '') or ''
# 兼容不同的字段名：keywords 或 keywords_template
keywords_raw = task.get('keywords') or task.get('keywords_template', '') or ''
reward = task.get('node_power_reward', 0)
```

---

## 测试验证

### 测试场景1：数据库有 task_template 和 keywords_template 字段
1. 领取一个任务
2. 点击"提交链接"按钮
3. **预期结果**：正常显示提交界面，使用 task_template 和 keywords_template 的值

### 测试场景2：数据库有 description 和 keywords 字段
1. 领取一个任务
2. 点击"提交链接"按钮
3. **预期结果**：正常显示提交界面，使用 description 和 keywords 的值

### 测试场景3：数据库只有基本字段
1. 领取一个任务
2. 点击"提交链接"按钮
3. **预期结果**：正常显示提交界面，description 和 keywords 为空字符串

---

## 影响范围

### 受影响的功能
- ✅ 提交链接功能
- ✅ 任务信息显示

### 不受影响的功能
- ✅ 任务领取
- ✅ 链接验证
- ✅ 反刷量系统
- ✅ 奖励发放

---

## 后续优化建议

### 1. 统一数据库表结构

建议明确数据库表结构，并在代码中统一字段名：

**方案A：使用 description 和 keywords**
```sql
ALTER TABLE drama_tasks 
ADD COLUMN IF NOT EXISTS description TEXT,
ADD COLUMN IF NOT EXISTS keywords TEXT;

-- 如果有旧字段，迁移数据
UPDATE drama_tasks SET description = task_template WHERE description IS NULL;
UPDATE drama_tasks SET keywords = keywords_template WHERE keywords IS NULL;

-- 删除旧字段
ALTER TABLE drama_tasks DROP COLUMN IF EXISTS task_template;
ALTER TABLE drama_tasks DROP COLUMN IF EXISTS keywords_template;
```

**方案B：使用 task_template 和 keywords_template**
```sql
ALTER TABLE drama_tasks 
ADD COLUMN IF NOT EXISTS task_template TEXT,
ADD COLUMN IF NOT EXISTS keywords_template TEXT;

-- 如果有旧字段，迁移数据
UPDATE drama_tasks SET task_template = description WHERE task_template IS NULL;
UPDATE drama_tasks SET keywords_template = keywords WHERE keywords_template IS NULL;

-- 删除旧字段
ALTER TABLE drama_tasks DROP COLUMN IF EXISTS description;
ALTER TABLE drama_tasks DROP COLUMN IF EXISTS keywords;
```

### 2. 添加数据库迁移脚本

创建一个独立的数据库迁移脚本，确保所有环境的数据库表结构一致：

```python
def migrate_database():
    """数据库迁移脚本"""
    conn = get_db_connection()
    cur = conn.cursor()
    
    try:
        # 检查字段是否存在
        cur.execute("""
            SELECT column_name 
            FROM information_schema.columns 
            WHERE table_name='drama_tasks'
        """)
        existing_columns = [row['column_name'] for row in cur.fetchall()]
        
        # 添加缺失的字段
        if 'task_template' not in existing_columns:
            cur.execute("ALTER TABLE drama_tasks ADD COLUMN task_template TEXT")
            logger.info("✅ Added column: task_template")
        
        if 'keywords_template' not in existing_columns:
            cur.execute("ALTER TABLE drama_tasks ADD COLUMN keywords_template TEXT")
            logger.info("✅ Added column: keywords_template")
        
        conn.commit()
        logger.info("✅ Database migration completed")
    except Exception as e:
        logger.error(f"❌ Database migration failed: {e}")
        conn.rollback()
    finally:
        cur.close()
        conn.close()
```

### 3. 添加字段存在性检查

在关键位置添加字段存在性检查，避免类似错误：

```python
def get_task_field(task, field_names, default=''):
    """安全获取任务字段，支持多个候选字段名"""
    if isinstance(field_names, str):
        field_names = [field_names]
    
    for field_name in field_names:
        value = task.get(field_name)
        if value:
            return value
    
    return default

# 使用示例
description = get_task_field(task, ['description', 'task_template'], '')
keywords = get_task_field(task, ['keywords', 'keywords_template'], '')
```

---

## 相关链接

- **GitHub提交**: https://github.com/rogerwu188/telegram-bot-dramarelay/commit/2d7fbba
- **上一次修复**: d36dc02 (修复提交链接无响应问题并调整任务领取文案)
- **Railway部署**: https://web-production-b95cb.up.railway.app

---

## 修复历史

1. **ad22b72**: 修复返回按钮响应慢和提交任务提示文案不完整的问题
2. **d36dc02**: 修复提交链接无响应问题（keywords为空导致异常）
3. **2d7fbba**: 修复数据库字段名错误（本次修复）

---

**修复完成** ✅
