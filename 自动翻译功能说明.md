# DramaRelay Bot - 自动翻译功能说明

## 功能概述

当英文用户查看只有中文内容的任务时，Bot 会自动调用 Gemini API 将中文内容翻译成英文，并将翻译结果缓存到数据库，避免重复翻译。

---

## 工作原理

### 1. 触发条件

- 用户语言设置为英文（`user_lang == 'en'`）
- 任务的 `title_en` 或 `description_en` 字段为空
- 任务有中文内容（`title` 或 `description`）

### 2. 翻译流程

```
英文用户查看任务
    ↓
检查是否有英文内容？
    ↓ 否
调用 Gemini API 翻译
    ↓
保存到数据库 (title_en, description_en)
    ↓
显示英文内容给用户
```

### 3. 缓存机制

- **首次翻译**：调用 API，耗时约 1-3 秒
- **后续查看**：直接从数据库读取，即时显示
- **成本优化**：每个任务只翻译一次

---

## 技术实现

### 翻译模块 (`translator.py`)

```python
def translate_to_english(text, context="drama task"):
    """
    使用 Gemini API 翻译中文文本
    
    Args:
        text: 中文文本
        context: 上下文（drama title / drama description）
    
    Returns:
        英文翻译结果
    """
```

### Bot 集成 (`bot.py`)

```python
def get_task_title(task, user_lang, auto_translate=True):
    """
    获取任务标题，自动翻译
    
    - 如果有 title_en，直接返回
    - 如果没有且 auto_translate=True，调用翻译并缓存
    - 否则返回中文标题
    """

def get_task_description(task, user_lang, auto_translate=True):
    """
    获取任务描述，自动翻译
    
    - 如果有 description_en，直接返回
    - 如果没有且 auto_translate=True，调用翻译并缓存
    - 否则返回中文描述
    """
```

---

## API 配置

### 使用 Gemini API（通过 OpenAI 兼容接口）

**环境变量：**
```bash
OPENAI_API_KEY=<your_api_key>
OPENAI_BASE_URL=<gemini_compatible_endpoint>
```

**模型：**
- `gemini-2.5-flash`（快速、低成本）

**参数：**
- `temperature`: 0.3（保证翻译一致性）
- `max_tokens`: 500（足够翻译任务内容）

---

## 数据库字段

### `drama_tasks` 表

| 字段 | 类型 | 说明 |
|------|------|------|
| `title` | TEXT | 任务标题（中文） |
| `title_en` | TEXT | 任务标题（英文，自动翻译或手动提供） |
| `description` | TEXT | 任务描述（中文） |
| `description_en` | TEXT | 任务描述（英文，自动翻译或手动提供） |

---

## 使用场景

### 场景 1：X2C 平台提供中英文内容

```json
{
  "title": "霸道总裁爱上我 第1集",
  "title_en": "The Domineering CEO Loves Me - Episode 1",
  "description": "一个关于爱情的故事",
  "description_en": "A story about love"
}
```

✅ **结果**：直接使用提供的英文内容，不调用翻译 API

---

### 场景 2：X2C 平台只提供中文内容

```json
{
  "title": "霸道总裁爱上我 第1集",
  "description": "一个关于爱情的故事"
}
```

✅ **结果**：
1. 英文用户首次查看时，自动翻译
2. 翻译结果保存到 `title_en` 和 `description_en`
3. 后续查看直接使用缓存

---

## 成本估算

### Gemini API 定价（参考）

- **gemini-2.5-flash**: 免费额度充足
- **每次翻译**：约 50-200 tokens
- **每个任务**：只翻译一次（缓存）

### 示例计算

假设：
- 1000 个任务
- 每个任务翻译 2 次（标题 + 描述）
- 平均每次 100 tokens

**总消耗**：1000 × 2 × 100 = 200,000 tokens

在免费额度内，成本几乎为零。

---

## 翻译质量

### 示例 1：任务标题

| 中文 | 英文（自动翻译） |
|------|------------------|
| 霸道总裁爱上我 第1集 | The Domineering CEO Loves Me, Episode 1 |
| 养母胜生母 第3集 | Adoptive Mother Surpasses Birth Mother, Episode 3 |
| 都市甜宠剧 | Urban Sweet Romance Drama |

### 示例 2：任务描述

| 中文 | 英文（自动翻译） |
|------|------------------|
| 一个关于亲情与爱的感人故事 | A touching story about family and love |
| 都市男女的甜宠生活，背后又藏着怎样的波澜？ | The sweet life of urban men and women, what turmoil is hidden behind it? |

---

## 故障处理

### 翻译失败

**原因：**
- API 配额用完
- 网络超时
- API 错误

**处理：**
- 返回原中文内容
- 记录错误日志
- 下次查看时重试

### 日志示例

```
🌐 Translating text: 霸道总裁爱上我 第1集...
✅ Translation successful: The Domineering CEO Loves Me, Episode 1
✅ Cached translation for task 55
```

---

## 测试方法

### 1. 创建只有中文内容的任务

```bash
curl -X POST https://web-production-b95cb.up.railway.app/api/tasks \
  -H "Content-Type: application/json" \
  -H "X-API-Key: x2c_admin_secret_key_2024" \
  -d '{
    "project_id": "test-001",
    "task_id": 1,
    "title": "测试任务",
    "description": "这是一个测试",
    "video_url": "https://example.com/video.mp4",
    "duration": 30,
    "node_power_reward": 10,
    "platform_requirements": "YouTube,TikTok",
    "status": "active"
  }'
```

### 2. 切换到英文语言

在 Telegram Bot 中：
1. 发送 `/start`
2. 点击 "⚙️ Settings"
3. 选择 "🇬🇧 English"

### 3. 查看任务

1. 点击 "📋 View Tasks"
2. 选择测试任务
3. 观察标题和描述是否自动翻译

### 4. 验证缓存

1. 返回任务列表
2. 再次查看同一任务
3. 应该立即显示（无翻译延迟）

### 5. 检查数据库

```sql
SELECT task_id, title, title_en, description, description_en 
FROM drama_tasks 
WHERE task_id = 1;
```

应该看到 `title_en` 和 `description_en` 已填充。

---

## 最佳实践

### 1. 提供高质量的中文内容

翻译质量取决于原文质量。建议：
- 使用标准中文
- 避免网络俚语
- 保持语句完整

### 2. 手动提供英文内容（推荐）

对于重要任务，建议 X2C 平台直接提供英文内容：
- 翻译质量更可控
- 响应速度更快
- 节省 API 成本

### 3. 监控翻译日志

定期检查日志，确保翻译功能正常：
```bash
# Railway 日志中搜索
grep "Translation" deploy.log
```

---

## 未来优化

### 1. 批量翻译

在任务创建时，后台批量翻译所有任务：
- 用户查看时无延迟
- 可以统一审核翻译质量

### 2. 翻译缓存预热

定期扫描没有英文内容的任务，提前翻译：
```python
# 伪代码
tasks = get_tasks_without_english()
for task in tasks:
    translate_and_cache(task)
```

### 3. 人工审核

提供管理界面，允许人工修正翻译：
- 查看自动翻译结果
- 手动编辑优化
- 保存到数据库

---

## 总结

✅ **已实现功能：**
- 自动检测缺失的英文内容
- 调用 Gemini API 翻译
- 缓存到数据库
- 故障降级（返回中文）

✅ **优势：**
- 对用户透明（自动完成）
- 成本低（只翻译一次）
- 质量好（Gemini 2.5 Flash）
- 可扩展（支持批量翻译）

✅ **适用场景：**
- X2C 平台只提供中文内容
- 需要快速支持英文用户
- 预算有限，无法人工翻译

---

**文档版本**：v1.0  
**更新日期**：2024-11-29  
**作者**：DramaRelay Bot Team
