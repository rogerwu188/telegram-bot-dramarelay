# 需求分析 - 最小改动原则调整

## 新需求 vs 现有实现

### 1. 任务下发接口差异

#### 现有实现
```json
// 请求
{
  "project_id": "550e8400-...",
  "title": "...",
  ...
}

// 响应
{
  "success": true,
  "data": {
    "task_id": 42,  // Bot内部生成的ID
    "project_id": "550e8400-...",
    "title": "...",
    "created_at": "..."
  }
}
```

#### 新需求
```json
// 请求
{
  "project_id": "550e8400-...",
  "task_id": 42,  // X2C平台提供的ID
  "title": "...",
  ...
}

// 响应
{
  "success": true,
  "project_id": "550e8400-...",
  "task_id": 42  // 返回X2C提供的ID
}
```

**关键变化：**
- ❌ Bot不再自动生成task_id
- ✅ 接收X2C平台提供的task_id
- ✅ 响应简化，只返回project_id + task_id确认

**问题：**
- 数据库中task_id是SERIAL主键，会自动递增
- 需要将X2C的task_id存储到另一个字段（如external_task_id）
- 或者修改数据库结构（风险较大）

**建议方案：**
- 添加 `external_task_id` 字段存储X2C的task_id
- 保持 `task_id` 作为Bot内部主键
- 在回传时使用 `external_task_id`

---

### 2. 统计回传接口差异

#### 现有实现
```json
{
  "event": "task.completed",
  "timestamp": "...",
  "data": {
    "project_id": "550e8400-...",
    "task_id": 42,
    "user_id": 123456789,
    "platform": "TikTok",
    "submission_link": "...",
    "node_power_earned": 10,
    ...
  }
}
```
**触发时机：** 每个用户完成任务时调用一次

#### 新需求
```json
{
  "site_name": "DramaRelayBot",
  "stats": [
    {
      "project_id": "550e8400-...",
      "task_id": 42,
      "duration": 30,
      "view_count": 5000,
      "like_count": 200,
      "account_count": 8,
      "yt_view_count": 3000,
      "yt_like_count": 120,
      "yt_account_count": 3,
      "tt_view_count": 2000,
      "tt_like_count": 80,
      "tt_account_count": 5
    }
  ]
}
```
**触发时机：** 保持不变（完成即调用）

**关键变化：**
- ✅ 增加 `site_name` 字段（固定值："DramaRelayBot"）
- ✅ 数据结构改为 `stats` 数组
- ✅ 需要按平台分类统计（YouTube、TikTok等）
- ✅ 统计维度：view_count、like_count、account_count
- ❌ 不再发送用户级别的详细信息

**问题：**
1. **触发时机矛盾：**
   - 现有：每个用户完成时调用
   - 新需求：发送聚合统计数据
   - 如何理解"完成即调用"？

2. **统计数据来源：**
   - Bot目前没有抓取view_count、like_count等数据
   - 只有verification_details中可能包含这些信息
   - 需要确认数据来源

**可能的理解：**
- 方案A：每个用户完成时，发送该用户的统计（stats数组只有1条）
- 方案B：定期聚合所有用户的统计，批量发送
- 方案C：每个用户完成时，发送该任务的累计统计

---

### 3. 数据库表结构调整需求

#### 现有表结构
```sql
CREATE TABLE drama_tasks (
    task_id SERIAL PRIMARY KEY,  -- Bot内部ID
    project_id VARCHAR(255),
    title VARCHAR(255),
    ...
);
```

#### 需要添加的字段
```sql
ALTER TABLE drama_tasks ADD COLUMN external_task_id VARCHAR(255);
CREATE INDEX idx_external_task_id ON drama_tasks(external_task_id);
```

**说明：**
- `external_task_id`: 存储X2C平台提供的task_id
- 保持 `task_id` 作为内部主键，避免大规模修改

---

## 待确认的问题

### 问题1：task_id的映射关系
- X2C的task_id是什么类型？（整数？UUID？字符串？）
- Bot内部的task_id如何与X2C的task_id对应？
- 建议：添加external_task_id字段存储X2C的ID

### 问题2：统计回传的触发时机
- "完成即调用"具体指什么？
  - A. 每个用户完成任务时调用（发送该用户的统计）
  - B. 每个用户完成任务时调用（发送该任务的累计统计）
  - C. 其他？

### 问题3：统计数据的来源
- view_count、like_count等数据从哪里获取？
  - Bot目前没有主动抓取这些数据
  - 只在verification_details中可能有（但不是所有提交都有）
- 如果数据不存在，是否发送0？

### 问题4：平台分类统计
- 如何区分YouTube、TikTok等平台？
  - 根据submission_link的域名判断？
  - 用户提交时选择的platform字段？
- 如果某个平台没有数据，是否发送0？

---

## 建议的实施方案

### 方案A：最小改动（推荐）

#### 1. 数据库调整
```sql
ALTER TABLE drama_tasks ADD COLUMN external_task_id VARCHAR(255);
CREATE INDEX idx_external_task_id ON drama_tasks(external_task_id);
```

#### 2. 任务接收接口
- 接收 `task_id` 参数，存储到 `external_task_id` 字段
- 响应返回 `project_id` + `task_id`（返回X2C提供的值）

#### 3. 统计回传接口
**假设：每个用户完成时调用，发送该用户的统计**

```json
{
  "site_name": "DramaRelayBot",
  "stats": [
    {
      "project_id": "550e8400-...",
      "task_id": 42,  // external_task_id
      "duration": 30,
      "view_count": 150,  // 从verification_details获取，无则为0
      "like_count": 20,
      "account_count": 1,  // 单个用户
      "yt_view_count": 150,  // 如果是YouTube
      "yt_like_count": 20,
      "yt_account_count": 1,
      "tt_view_count": 0,  // 如果不是TikTok则为0
      "tt_like_count": 0,
      "tt_account_count": 0
    }
  ]
}
```

**优点：**
- 改动最小
- 保持现有触发逻辑
- 数据实时性高

**缺点：**
- 每个用户都会触发回调，频率较高
- 统计数据是单个用户的，不是聚合的

---

### 方案B：聚合统计

#### 统计回传接口
**假设：每个用户完成时调用，发送该任务的累计统计**

```json
{
  "site_name": "DramaRelayBot",
  "stats": [
    {
      "project_id": "550e8400-...",
      "task_id": 42,
      "duration": 30,
      "view_count": 5000,  // 所有用户的总和
      "like_count": 200,
      "account_count": 8,  // 完成该任务的用户数
      "yt_view_count": 3000,
      "yt_like_count": 120,
      "yt_account_count": 3,
      "tt_view_count": 2000,
      "tt_like_count": 80,
      "tt_account_count": 5
    }
  ]
}
```

**优点：**
- 符合示例数据的格式
- X2C平台可以直接看到任务的总体进度

**缺点：**
- 每次都需要查询数据库聚合统计
- 性能开销较大

---

## 推荐方案

**建议采用方案A（最小改动）**，但需要您确认：

1. **X2C的task_id是什么格式？**（整数/UUID/字符串）
2. **统计回传是发送单个用户的数据，还是任务的累计数据？**
3. **view_count、like_count等数据如何获取？**（如果没有是否发送0）
4. **平台分类的逻辑是什么？**（根据submission_link判断还是platform字段）

请确认这些问题，我将按照您的要求调整代码。
