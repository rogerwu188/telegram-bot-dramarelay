<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DramaRelay Bot - ç®¡ç†é¢æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-card .label {
            color: #666;
            font-size: 0.9em;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .controls label {
            font-weight: 600;
            color: #555;
        }
        
        .controls select {
            padding: 8px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .controls select:hover {
            border-color: #667eea;
        }
        
        .controls button {
            padding: 8px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .controls button:hover {
            background: #5568d3;
        }
        
        .section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .section-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .section-header h2 {
            font-size: 1.5em;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Tab æ ·å¼ */
        .tabs {
            display: flex;
            gap: 0;
            border-bottom: none;
        }
        
        .tab-btn {
            padding: 15px 30px;
            background: #e0e0e0;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            border-radius: 0;
            border-right: 1px solid #ccc;
        }
        
        .tab-btn:first-child {
            border-top-left-radius: 0;
        }
        
        .tab-btn:last-child {
            border-right: none;
            border-top-right-radius: 0;
        }
        
        .tab-btn:hover {
            background: #d0d0d0;
            color: #333;
        }
        
        .tab-btn.active {
            background: white;
            color: #667eea;
            font-weight: 600;
            border-bottom: 3px solid #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section-content {
            padding: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #e0e0e0;
        }
        
        table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        table tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .badge.success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge.danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge.secondary {
            background: #e2e3e5;
            color: #383d41;
        }
        
        .badge-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .link {
            color: #667eea;
            text-decoration: none;
            word-break: break-all;
        }
        
        .link:hover {
            text-decoration: underline;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .empty {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .timestamp {
            color: #999;
            font-size: 0.9em;
        }
        
        .btn-view {
            padding: 5px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.85em;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-view:hover {
            background: #5568d3;
        }
        
        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 0;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s;
        }
        
        .modal-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.3em;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .modal-body {
            padding: 20px;
            max-height: calc(80vh - 140px);
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 15px 20px;
            background: #f8f9fa;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .btn-copy {
            padding: 8px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-copy:hover {
            background: #218838;
        }
        
        .json-viewer {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            header h1 {
                font-size: 1.5em;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            table {
                font-size: 0.9em;
            }
            
            table th, table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>ğŸ¤– DramaRelay Bot ç®¡ç†é¢æ¿</h1>
            <p>å®æ—¶ç›‘æ§ä»»åŠ¡åˆ†å‘ã€å®Œæˆæƒ…å†µå’Œ Webhook å›è°ƒçŠ¶æ€</p>
        </div>
    </header>
    
    <div class="container">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid" id="stats">
            <div class="stat-card">
                <div class="number" id="stat-tasks">-</div>
                <div class="label">æ€»ä»»åŠ¡æ•°</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-users">-</div>
                <div class="label">å‚ä¸ç”¨æˆ·</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-completed">-</div>
                <div class="label">å®Œæˆç”¨æˆ·</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-webhooks-success">-</div>
                <div class="label">æˆåŠŸå›è°ƒ</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-webhooks-failed">-</div>
                <div class="label">å¤±è´¥å›è°ƒ</div>
            </div>
        </div>
        
        <!-- API Key é…ç½® -->
        <div class="controls" style="margin-bottom: 20px; background: #fff3cd; border-left: 4px solid #ffc107;">
            <div style="flex: 1;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #856404;">
                    ğŸ”‘ API Key ï¼ˆä¾›å¤–éƒ¨ç³»ç»Ÿè°ƒç”¨ï¼‰
                </label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="password" id="api-key-display" readonly 
                           style="flex: 1; padding: 10px; border: 2px solid #ffc107; border-radius: 5px; font-family: monospace; font-size: 14px; background: white;"
                           value="Loading...">
                    <button onclick="toggleApiKeyVisibility()" 
                            style="padding: 10px 20px; background: #ffc107; color: #856404; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                        ğŸ‘ï¸ æ˜¾ç¤º/éšè—
                    </button>
                    <button onclick="copyApiKey()" 
                            style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                        ğŸ“‹ å¤åˆ¶
                    </button>
                </div>
                <small style="color: #856404; display: block; margin-top: 5px;">
                    âš ï¸ è¯·å¦¥å–„ä¿ç®¡ API Keyï¼Œä¸è¦åˆ†äº«ç»™æœªç»æˆæƒçš„äººå‘˜
                </small>
            </div>
        </div>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls">
            <label for="time-range">æ—¶é—´èŒƒå›´:</label>
            <select id="time-range">
                <option value="0" selected>æ‰€æœ‰æ—¶é—´</option>
                <option value="1">æœ€è¿‘ 1 å°æ—¶</option>
                <option value="6">æœ€è¿‘ 6 å°æ—¶</option>
                <option value="24">æœ€è¿‘ 24 å°æ—¶</option>
                <option value="72">æœ€è¿‘ 3 å¤©</option>
                <option value="168">æœ€è¿‘ 7 å¤©</option>
            </select>
            
            <label for="limit">æ˜¾ç¤ºæ¡æ•°:</label>
            <select id="limit">
                <option value="20">20 æ¡</option>
                <option value="50" selected>50 æ¡</option>
                <option value="100">100 æ¡</option>
                <option value="200">200 æ¡</option>
            </select>
            
            <button onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            <button onclick="autoRefresh()">â±ï¸ è‡ªåŠ¨åˆ·æ–° (30s)</button>
            <button onclick="toggleBroadcaster()" id="broadcaster-btn" style="background: #28a745;">
                ğŸ“¡ å¯åŠ¨åˆ†å‘æ•°æ®å›ä¼ 
            </button>
            <button onclick="triggerBroadcast()" style="background: #17a2b8;" id="trigger-btn">
                ğŸš€ ç«‹å³å›ä¼ ä¸€æ¬¡
            </button>
        </div>
        
        <!-- è¿›åº¦æ¡å’Œå€’è®¡æ—¶æ˜¾ç¤ºåŒºåŸŸ -->
        <div id="progress-area" style="margin: 15px 0; display: none;">
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span id="progress-text" style="font-weight: 500;">æ­£åœ¨å›ä¼ æ•°æ®...</span>
                    <span id="progress-percent" style="font-weight: bold; color: #007bff;">0%</span>
                </div>
                <div style="background: #e9ecef; height: 20px; border-radius: 10px; overflow: hidden;">
                    <div id="progress-bar" style="background: linear-gradient(90deg, #007bff, #0056b3); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                </div>
            </div>
        </div>
        
        <!-- å®šæ—¶å›ä¼ å€’è®¡æ—¶æ˜¾ç¤º -->
        <div id="countdown-area" style="margin: 15px 0; display: none;">
            <div style="background: #e7f3ff; padding: 15px 20px; border-radius: 8px; border: 1px solid #b3d9ff;">
                <!-- å€’è®¡æ—¶ -->
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span style="font-size: 20px;">â°</span>
                    <span style="font-weight: 500; color: #0056b3;">ä¸‹æ¬¡è‡ªåŠ¨å›ä¼ å€’è®¡æ—¶ï¼š</span>
                    <span id="countdown-timer" style="font-weight: bold; font-size: 18px; color: #007bff;">3:00</span>
                </div>
                <!-- å›ä¼ ç»Ÿè®¡ -->
                <div id="broadcast-stats" style="display: none; padding-top: 10px; border-top: 1px solid #b3d9ff;">
                    <div style="display: flex; gap: 30px; font-size: 14px;">
                        <div>
                            <span style="color: #666;">ä¸Šæ¬¡å›ä¼ ä»»åŠ¡æ•°ï¼š</span>
                            <span id="last-broadcast-tasks" style="font-weight: bold; color: #28a745;">0</span>
                        </div>
                        <div>
                            <span style="color: #666;">æ€»æ’­æ”¾é‡ï¼š</span>
                            <span id="last-broadcast-views" style="font-weight: bold; color: #007bff;">0</span>
                        </div>
                        <div>
                            <span style="color: #666;">æˆåŠŸ/å¤±è´¥ï¼š</span>
                            <span id="last-broadcast-success" style="font-weight: bold; color: #28a745;">0</span>
                            <span style="color: #999;">/</span>
                            <span id="last-broadcast-failed" style="font-weight: bold; color: #dc3545;">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ä»»åŠ¡æ—¥å¿— Tab é¡µ -->
        <div class="section">
            <div class="section-header">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('webhooks')">ğŸ“¤ Webhook å›è°ƒæ—¥å¿—</button>
                    <button class="tab-btn" onclick="switchTab('tasks')">ğŸ“¥ ä»»åŠ¡æ¥æ”¶æ—¥å¿—</button>
                    <button class="tab-btn" onclick="switchTab('errors')">âŒ å›ä¼ é”™è¯¯æ—¥å¿—</button>
                </div>
            </div>
            
            <!-- Webhook å›è°ƒæ—¥å¿— Tab -->
            <div id="tab-webhooks" class="tab-content active">
                <div class="section-content">
                    <div id="webhooks-loading" class="loading">åŠ è½½ä¸­...</div>
                    <div id="webhooks-error" class="error" style="display: none;"></div>
                    <div id="webhooks-empty" class="empty" style="display: none;">æš‚æ— å›è°ƒè®°å½•</div>
                    <div id="webhooks-table" style="display: none;">
                        <table>
                            <thead>
                                <tr>
                                    <th>ä»»åŠ¡ID</th>
                                    <th>ä»»åŠ¡æ ‡é¢˜</th>
                                    <th>Project ID</th>
                                    <th>å®Œæˆæ•°</th>
                                    <th>å›è°ƒçŠ¶æ€</th>
                                    <th>å›è°ƒæ—¶é—´</th>
                                    <th>é‡è¯•æ¬¡æ•°</th>
                                    <th>æœ€åå°è¯•</th>
                                    <th>å›è°ƒURL</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="webhooks-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- ä»»åŠ¡æ¥æ”¶æ—¥å¿— Tab -->
            <div id="tab-tasks" class="tab-content">
                <div class="section-content">
                    <div id="tasks-loading" class="loading">åŠ è½½ä¸­...</div>
                    <div id="tasks-error" class="error" style="display: none;"></div>
                    <div id="tasks-empty" class="empty" style="display: none;">æš‚æ— ä»»åŠ¡è®°å½•</div>
                    <div id="tasks-table" style="display: none;">
                        <table>
                            <thead>
                                <tr>
                                    <th>ä»»åŠ¡ID</th>
                                    <th>External ID</th>
                                    <th>Project ID</th>
                                    <th>æ ‡é¢˜</th>
                                    <th>å‰§é›†ç±»å‹</th>
                                    <th>å¹³å°</th>
                                    <th>å¥–åŠ±</th>
                                    <th>åˆ†å‘æ•°</th>
                                    <th>å®Œæˆæ•°</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="tasks-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- å›ä¼ é”™è¯¯æ—¥å¿— Tab -->
            <div id="tab-errors" class="tab-content">
                <div class="section-content">
                    <div id="errors-loading" class="loading">åŠ è½½ä¸­...</div>
                    <div id="errors-error" class="error" style="display: none;"></div>
                    <div id="errors-empty" class="empty" style="display: none;">æš‚æ— é”™è¯¯è®°å½•</div>
                    <div id="errors-table" style="display: none;">
                        <table>
                            <thead>
                                <tr>
                                    <th>ä»»åŠ¡ID</th>
                                    <th>ä»»åŠ¡æ ‡é¢˜</th>
                                    <th>Project ID</th>
                                    <th>è§†é¢‘é“¾æ¥</th>
                                    <th>å¹³å°</th>
                                    <th>é”™è¯¯ç±»å‹</th>
                                    <th>é”™è¯¯è¯¦æƒ…</th>
                                    <th>å›è°ƒURL</th>
                                    <th>é”™è¯¯æ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody id="errors-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ä»»åŠ¡å®Œæˆæ—¥å¿— -->
        <div class="section">
            <div class="section-header">
                <h2>âœ… ä»»åŠ¡å®Œæˆæ—¥å¿—</h2>
            </div>
            <div class="section-content">
                <div id="completions-loading" class="loading">åŠ è½½ä¸­...</div>
                <div id="completions-error" class="error" style="display: none;"></div>
                <div id="completions-empty" class="empty" style="display: none;">æš‚æ— å®Œæˆè®°å½•</div>
                <div id="completions-table" style="display: none;">
                    <table>
                        <thead>
                            <tr>
                                <th>ç”¨æˆ·</th>
                                <th>ä»»åŠ¡æ ‡é¢˜</th>
                                <th>å‰§é›†ç±»å‹</th>
                                <th>å¹³å°</th>
                                <th>å¥–åŠ±</th>
                                <th>å®Œæˆæ—¶é—´</th>
                                <th>ç”¨æ—¶</th>
                                <th>æäº¤é“¾æ¥</th>
                            </tr>
                        </thead>
                        <tbody id="completions-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
    
    <script>
        let autoRefreshTimer = null;
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            return date.toLocaleString('zh-CN', { 
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        // æ ¼å¼åŒ–æ—¶é•¿
        function formatDuration(seconds) {
            if (!seconds) return '-';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}åˆ†${secs}ç§’`;
        }
        
        // æˆªæ–­æ–‡æœ¬
        function truncate(text, maxLength = 50) {
            if (!text) return '-';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }
        
        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                const hours = document.getElementById('time-range').value;
                const response = await fetch(`/api/logs/stats?hours=${hours}`);
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    document.getElementById('stat-tasks').textContent = data.total_tasks || 0;
                    document.getElementById('stat-users').textContent = data.total_users || 0;
                    document.getElementById('stat-completed').textContent = data.completed_users || 0;
                    document.getElementById('stat-webhooks-success').textContent = data.successful_callbacks || 0;
                    document.getElementById('stat-webhooks-failed').textContent = data.failed_callbacks || 0;
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½ Webhook æ—¥å¿—
        async function loadWebhooks() {
            const loading = document.getElementById('webhooks-loading');
            const error = document.getElementById('webhooks-error');
            const empty = document.getElementById('webhooks-empty');
            const table = document.getElementById('webhooks-table');
            const tbody = document.getElementById('webhooks-body');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            empty.style.display = 'none';
            table.style.display = 'none';
            
            try {
                const hours = document.getElementById('time-range').value;
                const limit = document.getElementById('limit').value;
                const response = await fetch(`/api/logs/webhooks?hours=${hours}&limit=${limit}`);
                const result = await response.json();
                
                loading.style.display = 'none';
                
                if (!result.success) {
                    error.textContent = 'åŠ è½½å¤±è´¥: ' + result.error;
                    error.style.display = 'block';
                    return;
                }
                
                if (result.count === 0) {
                    empty.style.display = 'block';
                    return;
                }
                
                tbody.innerHTML = '';
                result.data.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.external_task_id || item.task_id}</td>
                        <td>${truncate(item.title, 30)}</td>
                        <td><small>${truncate(item.project_id, 20)}</small></td>
                        <td>${item.completed_count}</td>
                        <td><span class="badge ${item.status_class}">${item.status_label}</span></td>
                        <td class="timestamp">${formatTime(item.created_at || item.callback_last_attempt)}</td>
                        <td>${item.callback_retry_count || 0}</td>
                        <td class="timestamp">${formatTime(item.callback_last_attempt)}</td>
                        <td><a href="${item.callback_url}" target="_blank" class="link">${truncate(item.callback_url, 40)}</a></td>
                        <td><button class="btn-view" onclick='showCallbackData(${JSON.stringify(item.callback_payload).replace(/'/g, "&apos;")})'>ğŸ‘ï¸ æŸ¥çœ‹æ•°æ®</button></td>
                    `;
                    tbody.appendChild(row);
                });
                
                table.style.display = 'block';
            } catch (err) {
                loading.style.display = 'none';
                error.textContent = 'åŠ è½½å¤±è´¥: ' + err.message;
                error.style.display = 'block';
            }
        }
        
        // åŠ è½½é”™è¯¯æ—¥å¿—
        async function loadErrorLogs() {
            const loading = document.getElementById('errors-loading');
            const error = document.getElementById('errors-error');
            const empty = document.getElementById('errors-empty');
            const table = document.getElementById('errors-table');
            const tbody = document.getElementById('errors-body');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            empty.style.display = 'none';
            table.style.display = 'none';
            
            try {
                const hours = document.getElementById('time-range').value;
                const limit = document.getElementById('limit').value;
                const response = await fetch(`/api/logs/errors?hours=${hours}&limit=${limit}`);
                const result = await response.json();
                
                loading.style.display = 'none';
                
                if (!result.success) {
                    error.textContent = 'åŠ è½½å¤±è´¥: ' + result.error;
                    error.style.display = 'block';
                    return;
                }
                
                if (result.count === 0) {
                    empty.style.display = 'block';
                    return;
                }
                
                tbody.innerHTML = '';
                result.data.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.task_id || '-'}</td>
                        <td>${truncate(item.task_title, 30)}</td>
                        <td><small>${truncate(item.project_id, 20)}</small></td>
                        <td><a href="${item.video_url}" target="_blank" class="link">${truncate(item.video_url, 30)}</a></td>
                        <td><span class="badge">${item.platform}</span></td>
                        <td><span class="badge badge-error">${item.error_type}</span></td>
                        <td><small>${truncate(item.error_message, 50)}</small></td>
                        <td><a href="${item.callback_url}" target="_blank" class="link">${truncate(item.callback_url, 30)}</a></td>
                        <td class="timestamp">${formatTime(item.created_at)}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                table.style.display = 'block';
            } catch (err) {
                loading.style.display = 'none';
                error.textContent = 'åŠ è½½å¤±è´¥: ' + err.message;
                error.style.display = 'block';
            }
        }
        
        // åŠ è½½å®Œæˆæ—¥å¿—
        async function loadCompletions() {
            const loading = document.getElementById('completions-loading');
            const error = document.getElementById('completions-error');
            const empty = document.getElementById('completions-empty');
            const table = document.getElementById('completions-table');
            const tbody = document.getElementById('completions-body');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            empty.style.display = 'none';
            table.style.display = 'none';
            
            try {
                const hours = document.getElementById('time-range').value;
                const limit = document.getElementById('limit').value;
                const response = await fetch(`/api/logs/completions?hours=${hours}&limit=${limit}`);
                const result = await response.json();
                
                loading.style.display = 'none';
                
                if (!result.success) {
                    error.textContent = 'åŠ è½½å¤±è´¥: ' + result.error;
                    error.style.display = 'block';
                    return;
                }
                
                if (result.count === 0) {
                    empty.style.display = 'block';
                    return;
                }
                
                tbody.innerHTML = '';
                result.data.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.display_name} <small>(${item.user_id})</small></td>
                        <td>${truncate(item.title, 30)}</td>
                        <td><span class="badge">${item.category ? (CATEGORY_NAMES_ZH[item.category] || item.category) : '-'}</span></td>
                        <td>${item.platform_requirements}</td>
                        <td>${item.node_power_reward} X2C</td>
                        <td class="timestamp">${formatTime(item.completed_at)}</td>
                        <td>${formatDuration(item.duration_seconds)}</td>
                        <td><a href="${item.submission_link}" target="_blank" class="link">${truncate(item.submission_link, 40)}</a></td>
                    `;
                    tbody.appendChild(row);
                });
                
                table.style.display = 'block';
            } catch (err) {
                loading.style.display = 'none';
                error.textContent = 'åŠ è½½å¤±è´¥: ' + err.message;
                error.style.display = 'block';
            }
        }
                // åˆ†ç±»ä¸­æ–‡æ˜ å°„
        const CATEGORY_NAMES_ZH = {
            'revenge': 'éœ¸é“æ€»è£/è±ªé—¨è™æ‹',
            'rebirth': 'ç©¿è¶Šé‡ç”Ÿ/é€†å¤©æ”¹å‘½',
            'revenge_slap': 'å¤ä»‡çˆ½æ–‡/æ‰“è„¸åæ€',
            'marriage': 'å©šæ‹é”™é…/å…ˆå©šåçˆ±',
            'sweet_romance': 'ç”œå® å°ç™½èŠ±/æ²»æ„ˆçˆ±æƒ…',
            'family': 'å®¶åº­ä¼¦ç†/å©†åª³å¤§æˆ˜',
            'detective': 'ç ´æ¡ˆåˆ‘ä¾¦/æ‚¬ç–‘æ¨ç†',
            'medical': 'åŒ»ç–—æ³•åº­/èŒåœºæƒè°‹',
            'career_woman': 'å¥³å¼ºæˆé•¿/èŒåœºé€†è¢­',
            'campus': 'æ ¡å›­é’æ˜¥/é’æ¶©æš—æ‹',
            'horror': 'ææ€–çµå¼‚/æ°‘ä¿—æ‚¬ç–‘',
            'scifi': 'èµ›åš/æœªæ¥ç§‘å¹»',
            'survival': 'æœ«æ—¥ç”Ÿå­˜/ä¸§å°¸ç¾éš¾',
            'costume': 'å®«æ–—å®…æ–—/å¤è£…æƒè°‹',
            'business': 'å•†æˆ˜åšå¼ˆ/èµ„æœ¬æ™ºæ–—',
            'rural': 'ä¹¡æ‘/äººç”Ÿæ²»æ„ˆç³»',
            'superpower': 'è¶…èƒ½åŠ›å˜å¼‚/è‹±é›„è§‰é†’',
            'triangle': 'ä¸‰è§’æ‹/ä¿®ç½—åœº',
            'underdog': 'å°äººç‰©å¤§æœºç¼˜',
            'dark': 'åç¤¾ä¼šæ€§äººæ ¼/é»‘æš—ç³»'
        };
        
        // åŠ è½½ä»»åŠ¡æ¥æ”¶æ—¥å¿—
        async function loadTasks() {            const loading = document.getElementById('tasks-loading');
            const error = document.getElementById('tasks-error');
            const empty = document.getElementById('tasks-empty');
            const table = document.getElementById('tasks-table');
            const tbody = document.getElementById('tasks-body');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            empty.style.display = 'none';
            table.style.display = 'none';
            
            try {
                const hours = document.getElementById('time-range').value;
                const limit = document.getElementById('limit').value;
                const response = await fetch(`/api/logs/tasks?hours=${hours}&limit=${limit}`);
                const result = await response.json();
                
                loading.style.display = 'none';
                
                if (!result.success) {
                    error.textContent = 'åŠ è½½å¤±è´¥: ' + result.error;
                    error.style.display = 'block';
                    return;
                }
                
                if (result.count === 0) {
                    empty.style.display = 'block';
                    return;
                }
                
                tbody.innerHTML = '';
                result.data.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.task_id}</td>
                        <td>${item.external_task_id || '-'}</td>
                        <td><small>${truncate(item.project_id, 20)}</small></td>
                        <td>${truncate(item.title, 30)}</td>
                        <td><span class="badge">${item.category ? (CATEGORY_NAMES_ZH[item.category] || item.category) : '-'}</span></td>
                        <td>${item.platform_requirements}</td>
                        <td>${item.node_power_reward} X2C</td>
                        <td>${item.assigned_users}</td>
                        <td>${item.completed_users}</td>
                        <td class="timestamp">${formatTime(item.created_at)}</td>
                        <td><button class="btn-view" onclick='showTaskData(${JSON.stringify(item.original_request).replace(/'/g, "&apos;")})'>ğŸ“ æŸ¥çœ‹æ•°æ®</button></td>
                    `;
                    tbody.appendChild(row);
                });
                
                table.style.display = 'block';
            } catch (err) {
                loading.style.display = 'none';
                error.textContent = 'åŠ è½½å¤±è´¥: ' + err.message;
                error.style.display = 'block';
            }
        }
        
        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        function refreshData() {
            loadStats();
            loadWebhooks();
            loadCompletions();
            loadTasks();
        }
        
        // è‡ªåŠ¨åˆ·æ–°
        function autoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
                alert('å·²åœæ­¢è‡ªåŠ¨åˆ·æ–°');
            } else {
                autoRefreshTimer = setInterval(refreshData, 30000);
                alert('å·²å¯åŠ¨è‡ªåŠ¨åˆ·æ–° (æ¯ 30 ç§’)');
                refreshData();
            }
        }
        
        // Tab åˆ‡æ¢å‡½æ•°
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰ tab å†…å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„ active çŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„ tab
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // æ¿€æ´»å¯¹åº”æŒ‰é’®
            event.target.classList.add('active');
            
            // å¦‚æœåˆ‡æ¢åˆ°é”™è¯¯æ—¥å¿—ï¼ŒåŠ è½½æ•°æ®
            if (tabName === 'errors') {
                loadErrorLogs();
            }
        }
        
        // ç›‘å¬æ§åˆ¶å˜åŒ–
        document.getElementById('time-range').addEventListener('change', refreshData);
        document.getElementById('limit').addEventListener('change', refreshData);
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            refreshData();
            loadApiKey();
        });
        
        // æ˜¾ç¤ºå›è°ƒæ•°æ®å¼¹çª—
        function showCallbackData(payload) {
            const modal = document.getElementById('callback-modal');
            const modalTitle = modal.querySelector('.modal-header h3');
            const jsonViewer = document.getElementById('json-viewer');
            modalTitle.textContent = 'ğŸ“¤ Webhook å›è°ƒæ•°æ®';
            jsonViewer.textContent = JSON.stringify(payload, null, 2);
            modal.classList.add('show');
        }
        
        // æ˜¾ç¤ºä»»åŠ¡åŸå§‹æ•°æ®å¼¹çª—
        function showTaskData(data) {
            const modal = document.getElementById('callback-modal');
            const modalTitle = modal.querySelector('.modal-header h3');
            const jsonViewer = document.getElementById('json-viewer');
            modalTitle.textContent = 'ğŸ“ ä»»åŠ¡åŸå§‹æ•°æ® (X2C å¹³å°ä¸‹å‘)';
            jsonViewer.textContent = JSON.stringify(data, null, 2);
            modal.classList.add('show');
        }
        
        // å…³é—­å¼¹çª—
        function closeModal() {
            const modal = document.getElementById('callback-modal');
            modal.classList.remove('show');
        }
        
        // å¤åˆ¶ JSON
        function copyJSON(event) {
            const jsonViewer = document.getElementById('json-viewer');
            const text = jsonViewer.textContent;
            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âœ… å·²å¤åˆ¶';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                alert('å¤åˆ¶å¤±è´¥ï¼š' + err.message);
            });
        }
        
        // API Key åŠŸèƒ½
        let apiKeyValue = '';
        let apiKeyVisible = false;
        
        // åŠ è½½ API Key
        async function loadApiKey() {
            try {
                const response = await fetch('/api/config/api-key');
                const result = await response.json();
                
                if (result.success) {
                    apiKeyValue = result.api_key;
                    document.getElementById('api-key-display').value = 'â€¢'.repeat(apiKeyValue.length);
                } else {
                    document.getElementById('api-key-display').value = 'åŠ è½½å¤±è´¥';
                }
            } catch (error) {
                console.error('åŠ è½½ API Key å¤±è´¥:', error);
                document.getElementById('api-key-display').value = 'åŠ è½½å¤±è´¥';
            }
        }
        
        // åˆ‡æ¢ API Key æ˜¾ç¤º/éšè—
        function toggleApiKeyVisibility() {
            const input = document.getElementById('api-key-display');
            apiKeyVisible = !apiKeyVisible;
            
            if (apiKeyVisible) {
                input.type = 'text';
                input.value = apiKeyValue;
            } else {
                input.type = 'password';
                input.value = 'â€¢'.repeat(apiKeyValue.length);
            }
        }
        
        // å¤åˆ¶ API Key
        function copyApiKey() {
            if (!apiKeyValue) {
                alert('âš ï¸ API Key å°šæœªåŠ è½½');
                return;
            }
            
            navigator.clipboard.writeText(apiKeyValue).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âœ… å·²å¤åˆ¶';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                alert('å¤åˆ¶å¤±è´¥ï¼š' + err.message);
            });
        }
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('callback-modal');
            if (e.target === modal) {
                closeModal();
            }
        });
        
        // åˆ†å‘æ•°æ®å›ä¼ åŠŸèƒ½
        let broadcasterRunning = false;
        
        // æ£€æŸ¥åˆ†å‘æœåŠ¡çŠ¶æ€
        async function checkBroadcasterStatus() {
            try {
                const response = await fetch('/api/broadcaster/status');
                const result = await response.json();
                
                if (result.success && result.data) {
                    broadcasterRunning = result.data.running;
                    updateBroadcasterButton();
                    
                    // å¦‚æœæœåŠ¡æ­£åœ¨è¿è¡Œï¼Œå¯åŠ¨å€’è®¡æ—¶
                    if (broadcasterRunning) {
                        startCountdown();
                    }
                }
            } catch (error) {
                console.error('æ£€æŸ¥åˆ†å‘æœåŠ¡çŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateBroadcasterButton() {
            const btn = document.getElementById('broadcaster-btn');
            if (broadcasterRunning) {
                btn.textContent = 'ğŸ›‘ åœæ­¢åˆ†å‘æ•°æ®å›ä¼ ';
                btn.style.background = '#dc3545';
            } else {
                btn.textContent = 'ğŸ“¡ å¯åŠ¨åˆ†å‘æ•°æ®å›ä¼ ';
                btn.style.background = '#28a745';
            }
        }
        
        // å€’è®¡æ—¶ç›¸å…³å˜é‡
        let countdownInterval = null;
        let countdownSeconds = 180; // 3åˆ†é’Ÿ = 180ç§’
        
        // å¯åŠ¨å€’è®¡æ—¶
        function startCountdown() {
            const countdownArea = document.getElementById('countdown-area');
            const countdownTimer = document.getElementById('countdown-timer');
            
            countdownArea.style.display = 'block';
            countdownSeconds = 180;
            
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            countdownInterval = setInterval(async () => {
                countdownSeconds--;
                
                if (countdownSeconds <= 0) {
                    countdownSeconds = 180; // é‡ç½®ä¸º3åˆ†é’Ÿ
                    // å›ä¼ å®Œæˆåï¼Œè·å–æœ€æ–°çš„å›ä¼ ç»Ÿè®¡
                    await updateBroadcastStats();
                }
                
                const minutes = Math.floor(countdownSeconds / 60);
                const seconds = countdownSeconds % 60;
                countdownTimer.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        // åœæ­¢å€’è®¡æ—¶
        function stopCountdown() {
            const countdownArea = document.getElementById('countdown-area');
            
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            
            countdownArea.style.display = 'none';
        }
        
        // æ›´æ–°å›ä¼ ç»Ÿè®¡æ•°æ®
        async function updateBroadcastStats() {
            try {
                const response = await fetch('/api/broadcaster/last_stats');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const data = result.data;
                    const statsArea = document.getElementById('broadcast-stats');
                    const tasksSpan = document.getElementById('last-broadcast-tasks');
                    const viewsSpan = document.getElementById('last-broadcast-views');
                    const successSpan = document.getElementById('last-broadcast-success');
                    const failedSpan = document.getElementById('last-broadcast-failed');
                    
                    tasksSpan.textContent = data.total || 0;
                    viewsSpan.textContent = (data.total_views || 0).toLocaleString();
                    successSpan.textContent = data.success_count || 0;
                    failedSpan.textContent = data.failed_count || 0;
                    
                    statsArea.style.display = 'block';
                }
            } catch (error) {
                console.error('è·å–å›ä¼ ç»Ÿè®¡å¤±è´¥:', error);
            }
        }
        
        // åˆ‡æ¢åˆ†å‘æœåŠ¡
        async function toggleBroadcaster() {
            const btn = document.getElementById('broadcaster-btn');
            btn.disabled = true;
            
            try {
                const endpoint = broadcasterRunning ? '/api/broadcaster/stop' : '/api/broadcaster/start';
                const response = await fetch(endpoint, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    broadcasterRunning = !broadcasterRunning;
                    updateBroadcasterButton();
                    
                    // å¯åŠ¨æˆ–åœæ­¢å€’è®¡æ—¶
                    if (broadcasterRunning) {
                        startCountdown();
                    } else {
                        stopCountdown();
                    }
                    
                    alert('âœ… ' + result.message);
                } else {
                    // é”™è¯¯ä¿¡æ¯å¯èƒ½åœ¨ message æˆ– error å­—æ®µä¸­
                    const errorMsg = result.message || result.error || 'æœªçŸ¥é”™è¯¯';
                    alert('âš ï¸ ' + errorMsg);
                }
            } catch (error) {
                alert('âŒ æ“ä½œå¤±è´¥: ' + error.message);
            } finally {
                btn.disabled = false;
            }
        }
        
        // ç«‹å³è§¦å‘ä¸€æ¬¡å›ä¼ 
        async function triggerBroadcast() {
            if (!confirm('ç¡®è®¤ç«‹å³å›ä¼ æ‰€æœ‰ä»»åŠ¡çš„æ’­æ”¾é‡æ•°æ®ï¼Ÿ')) {
                return;
            }
            
            const btn = event.target;
            const progressArea = document.getElementById('progress-area');
            const progressBar = document.getElementById('progress-bar');
            const progressPercent = document.getElementById('progress-percent');
            const progressText = document.getElementById('progress-text');
            
            btn.disabled = true;
            btn.textContent = 'â³ å›ä¼ ä¸­...';
            progressArea.style.display = 'block';
            
            // æ¨¡æ‹Ÿè¿›åº¦æ¡ï¼ˆå› ä¸ºåç«¯æ˜¯ä¸€æ¬¡æ€§è¿”å›ç»“æœï¼‰
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 5;
                if (progress >= 90) {
                    clearInterval(progressInterval);
                }
                progressBar.style.width = progress + '%';
                progressPercent.textContent = progress + '%';
            }, 100);
            
            try {
                const response = await fetch('/api/broadcaster/trigger', { method: 'POST' });
                const result = await response.json();
                
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                progressPercent.textContent = '100%';
                progressText.textContent = 'å›ä¼ å®Œæˆï¼';
                
                setTimeout(() => {
                    progressArea.style.display = 'none';
                    progressBar.style.width = '0%';
                    progressPercent.textContent = '0%';
                    progressText.textContent = 'æ­£åœ¨å›ä¼ æ•°æ®...';
                }, 2000);
                
                if (result.success && result.data) {
                    const data = result.data;
                    let message = `âœ… å›ä¼ å®Œæˆ\n\n`;
                    message += `æ€»ä»»åŠ¡æ•°: ${data.total}\n`;
                    message += `æˆåŠŸ: ${data.success_count}\n`;
                    message += `å¤±è´¥: ${data.failed_count}\n`;
                    if (data.total_views !== undefined) {
                        message += `æ€»æ’­æ”¾é‡: ${data.total_views.toLocaleString()}\n`;
                    }
                    message += `æ—¶é—´: ${data.timestamp}`;
                    alert(message);
                    
                    // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
                    await updateBroadcastStats();
                } else {
                    alert('âŒ å›ä¼ å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                clearInterval(progressInterval);
                progressArea.style.display = 'none';
                progressBar.style.width = '0%';
                alert('âŒ å›ä¼ å¤±è´¥: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸš€ ç«‹å³å›ä¼ ä¸€æ¬¡';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
        window.addEventListener('load', () => {
            checkBroadcasterStatus();
        });
    </script>
    
    <!-- å›è°ƒæ•°æ®å¼¹çª— -->
    <div id="callback-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“¤ Webhook å›è°ƒæ•°æ®</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <pre id="json-viewer" class="json-viewer"></pre>
            </div>
            <div class="modal-footer">
                <button class="btn-copy" onclick="copyJSON(event)">ğŸ“‹ å¤åˆ¶ JSON</button>
            </div>
        </div>
    </div>
</body>
</html>
