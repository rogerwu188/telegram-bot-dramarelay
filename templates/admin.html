<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DramaRelay Bot - ç®¡ç†é¢æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-card .label {
            color: #666;
            font-size: 0.9em;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .controls label {
            font-weight: 600;
            color: #555;
        }
        
        .controls select {
            padding: 8px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .controls select:hover {
            border-color: #667eea;
        }
        
        .controls button {
            padding: 8px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .controls button:hover {
            background: #5568d3;
        }
        
        .section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .section-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .section-header h2 {
            font-size: 1.5em;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-content {
            padding: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #e0e0e0;
        }
        
        table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        table tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .badge.success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge.danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge.secondary {
            background: #e2e3e5;
            color: #383d41;
        }
        
        .link {
            color: #667eea;
            text-decoration: none;
            word-break: break-all;
        }
        
        .link:hover {
            text-decoration: underline;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .empty {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .timestamp {
            color: #999;
            font-size: 0.9em;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            header h1 {
                font-size: 1.5em;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            table {
                font-size: 0.9em;
            }
            
            table th, table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>ğŸ¤– DramaRelay Bot ç®¡ç†é¢æ¿</h1>
            <p>å®æ—¶ç›‘æ§ä»»åŠ¡åˆ†å‘ã€å®Œæˆæƒ…å†µå’Œ Webhook å›è°ƒçŠ¶æ€</p>
        </div>
    </header>
    
    <div class="container">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid" id="stats">
            <div class="stat-card">
                <div class="number" id="stat-tasks">-</div>
                <div class="label">æ€»ä»»åŠ¡æ•°</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-users">-</div>
                <div class="label">å‚ä¸ç”¨æˆ·</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-completed">-</div>
                <div class="label">å®Œæˆç”¨æˆ·</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-webhooks-success">-</div>
                <div class="label">æˆåŠŸå›è°ƒ</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-webhooks-failed">-</div>
                <div class="label">å¤±è´¥å›è°ƒ</div>
            </div>
        </div>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls">
            <label for="time-range">æ—¶é—´èŒƒå›´:</label>
            <select id="time-range">
                <option value="1">æœ€è¿‘ 1 å°æ—¶</option>
                <option value="6">æœ€è¿‘ 6 å°æ—¶</option>
                <option value="24" selected>æœ€è¿‘ 24 å°æ—¶</option>
                <option value="72">æœ€è¿‘ 3 å¤©</option>
                <option value="168">æœ€è¿‘ 7 å¤©</option>
            </select>
            
            <label for="limit">æ˜¾ç¤ºæ¡æ•°:</label>
            <select id="limit">
                <option value="20">20 æ¡</option>
                <option value="50" selected>50 æ¡</option>
                <option value="100">100 æ¡</option>
                <option value="200">200 æ¡</option>
            </select>
            
            <button onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            <button onclick="autoRefresh()">â±ï¸ è‡ªåŠ¨åˆ·æ–° (30s)</button>
        </div>
        
        <!-- Webhook å›è°ƒæ—¥å¿— -->
        <div class="section">
            <div class="section-header">
                <h2>ğŸ“¤ Webhook å›è°ƒæ—¥å¿—</h2>
            </div>
            <div class="section-content">
                <div id="webhooks-loading" class="loading">åŠ è½½ä¸­...</div>
                <div id="webhooks-error" class="error" style="display: none;"></div>
                <div id="webhooks-empty" class="empty" style="display: none;">æš‚æ— å›è°ƒè®°å½•</div>
                <div id="webhooks-table" style="display: none;">
                    <table>
                        <thead>
                            <tr>
                                <th>ä»»åŠ¡ID</th>
                                <th>ä»»åŠ¡æ ‡é¢˜</th>
                                <th>Project ID</th>
                                <th>å®Œæˆæ•°</th>
                                <th>å›è°ƒçŠ¶æ€</th>
                                <th>é‡è¯•æ¬¡æ•°</th>
                                <th>æœ€åå°è¯•</th>
                                <th>å›è°ƒURL</th>
                            </tr>
                        </thead>
                        <tbody id="webhooks-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ä»»åŠ¡å®Œæˆæ—¥å¿— -->
        <div class="section">
            <div class="section-header">
                <h2>âœ… ä»»åŠ¡å®Œæˆæ—¥å¿—</h2>
            </div>
            <div class="section-content">
                <div id="completions-loading" class="loading">åŠ è½½ä¸­...</div>
                <div id="completions-error" class="error" style="display: none;"></div>
                <div id="completions-empty" class="empty" style="display: none;">æš‚æ— å®Œæˆè®°å½•</div>
                <div id="completions-table" style="display: none;">
                    <table>
                        <thead>
                            <tr>
                                <th>ç”¨æˆ·</th>
                                <th>ä»»åŠ¡æ ‡é¢˜</th>
                                <th>å¹³å°</th>
                                <th>å¥–åŠ±</th>
                                <th>å®Œæˆæ—¶é—´</th>
                                <th>ç”¨æ—¶</th>
                                <th>æäº¤é“¾æ¥</th>
                            </tr>
                        </thead>
                        <tbody id="completions-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ä»»åŠ¡æ¥æ”¶æ—¥å¿— -->
        <div class="section">
            <div class="section-header">
                <h2>ğŸ“¥ ä»»åŠ¡æ¥æ”¶æ—¥å¿—</h2>
            </div>
            <div class="section-content">
                <div id="tasks-loading" class="loading">åŠ è½½ä¸­...</div>
                <div id="tasks-error" class="error" style="display: none;"></div>
                <div id="tasks-empty" class="empty" style="display: none;">æš‚æ— ä»»åŠ¡è®°å½•</div>
                <div id="tasks-table" style="display: none;">
                    <table>
                        <thead>
                            <tr>
                                <th>ä»»åŠ¡ID</th>
                                <th>External ID</th>
                                <th>Project ID</th>
                                <th>æ ‡é¢˜</th>
                                <th>å¹³å°</th>
                                <th>å¥–åŠ±</th>
                                <th>åˆ†å‘æ•°</th>
                                <th>å®Œæˆæ•°</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody id="tasks-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let autoRefreshTimer = null;
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            return date.toLocaleString('zh-CN', { 
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        // æ ¼å¼åŒ–æ—¶é•¿
        function formatDuration(seconds) {
            if (!seconds) return '-';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}åˆ†${secs}ç§’`;
        }
        
        // æˆªæ–­æ–‡æœ¬
        function truncate(text, maxLength = 50) {
            if (!text) return '-';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }
        
        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                const hours = document.getElementById('time-range').value;
                const response = await fetch(`/api/logs/stats?hours=${hours}`);
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    document.getElementById('stat-tasks').textContent = data.total_tasks || 0;
                    document.getElementById('stat-users').textContent = data.total_users || 0;
                    document.getElementById('stat-completed').textContent = data.completed_users || 0;
                    document.getElementById('stat-webhooks-success').textContent = data.successful_callbacks || 0;
                    document.getElementById('stat-webhooks-failed').textContent = data.failed_callbacks || 0;
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½ Webhook æ—¥å¿—
        async function loadWebhooks() {
            const loading = document.getElementById('webhooks-loading');
            const error = document.getElementById('webhooks-error');
            const empty = document.getElementById('webhooks-empty');
            const table = document.getElementById('webhooks-table');
            const tbody = document.getElementById('webhooks-body');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            empty.style.display = 'none';
            table.style.display = 'none';
            
            try {
                const hours = document.getElementById('time-range').value;
                const limit = document.getElementById('limit').value;
                const response = await fetch(`/api/logs/webhooks?hours=${hours}&limit=${limit}`);
                const result = await response.json();
                
                loading.style.display = 'none';
                
                if (!result.success) {
                    error.textContent = 'åŠ è½½å¤±è´¥: ' + result.error;
                    error.style.display = 'block';
                    return;
                }
                
                if (result.count === 0) {
                    empty.style.display = 'block';
                    return;
                }
                
                tbody.innerHTML = '';
                result.data.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.external_task_id || item.task_id}</td>
                        <td>${truncate(item.title, 30)}</td>
                        <td><small>${truncate(item.project_id, 20)}</small></td>
                        <td>${item.completed_count}</td>
                        <td><span class="badge ${item.status_class}">${item.status_label}</span></td>
                        <td>${item.callback_retry_count || 0}</td>
                        <td class="timestamp">${formatTime(item.callback_last_attempt)}</td>
                        <td><a href="${item.callback_url}" target="_blank" class="link">${truncate(item.callback_url, 40)}</a></td>
                    `;
                    tbody.appendChild(row);
                });
                
                table.style.display = 'block';
            } catch (err) {
                loading.style.display = 'none';
                error.textContent = 'åŠ è½½å¤±è´¥: ' + err.message;
                error.style.display = 'block';
            }
        }
        
        // åŠ è½½å®Œæˆæ—¥å¿—
        async function loadCompletions() {
            const loading = document.getElementById('completions-loading');
            const error = document.getElementById('completions-error');
            const empty = document.getElementById('completions-empty');
            const table = document.getElementById('completions-table');
            const tbody = document.getElementById('completions-body');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            empty.style.display = 'none';
            table.style.display = 'none';
            
            try {
                const hours = document.getElementById('time-range').value;
                const limit = document.getElementById('limit').value;
                const response = await fetch(`/api/logs/completions?hours=${hours}&limit=${limit}`);
                const result = await response.json();
                
                loading.style.display = 'none';
                
                if (!result.success) {
                    error.textContent = 'åŠ è½½å¤±è´¥: ' + result.error;
                    error.style.display = 'block';
                    return;
                }
                
                if (result.count === 0) {
                    empty.style.display = 'block';
                    return;
                }
                
                tbody.innerHTML = '';
                result.data.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.display_name} <small>(${item.user_id})</small></td>
                        <td>${truncate(item.title, 30)}</td>
                        <td>${item.platform_requirements}</td>
                        <td>${item.node_power_reward} X2C</td>
                        <td class="timestamp">${formatTime(item.completed_at)}</td>
                        <td>${formatDuration(item.duration_seconds)}</td>
                        <td><a href="${item.submission_link}" target="_blank" class="link">${truncate(item.submission_link, 40)}</a></td>
                    `;
                    tbody.appendChild(row);
                });
                
                table.style.display = 'block';
            } catch (err) {
                loading.style.display = 'none';
                error.textContent = 'åŠ è½½å¤±è´¥: ' + err.message;
                error.style.display = 'block';
            }
        }
        
        // åŠ è½½ä»»åŠ¡æ—¥å¿—
        async function loadTasks() {
            const loading = document.getElementById('tasks-loading');
            const error = document.getElementById('tasks-error');
            const empty = document.getElementById('tasks-empty');
            const table = document.getElementById('tasks-table');
            const tbody = document.getElementById('tasks-body');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            empty.style.display = 'none';
            table.style.display = 'none';
            
            try {
                const hours = document.getElementById('time-range').value;
                const limit = document.getElementById('limit').value;
                const response = await fetch(`/api/logs/tasks?hours=${hours}&limit=${limit}`);
                const result = await response.json();
                
                loading.style.display = 'none';
                
                if (!result.success) {
                    error.textContent = 'åŠ è½½å¤±è´¥: ' + result.error;
                    error.style.display = 'block';
                    return;
                }
                
                if (result.count === 0) {
                    empty.style.display = 'block';
                    return;
                }
                
                tbody.innerHTML = '';
                result.data.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.task_id}</td>
                        <td>${item.external_task_id || '-'}</td>
                        <td><small>${truncate(item.project_id, 20)}</small></td>
                        <td>${truncate(item.title, 30)}</td>
                        <td>${item.platform_requirements}</td>
                        <td>${item.node_power_reward} X2C</td>
                        <td>${item.assigned_users}</td>
                        <td>${item.completed_users}</td>
                        <td class="timestamp">${formatTime(item.created_at)}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                table.style.display = 'block';
            } catch (err) {
                loading.style.display = 'none';
                error.textContent = 'åŠ è½½å¤±è´¥: ' + err.message;
                error.style.display = 'block';
            }
        }
        
        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        function refreshData() {
            loadStats();
            loadWebhooks();
            loadCompletions();
            loadTasks();
        }
        
        // è‡ªåŠ¨åˆ·æ–°
        function autoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
                alert('å·²åœæ­¢è‡ªåŠ¨åˆ·æ–°');
            } else {
                autoRefreshTimer = setInterval(refreshData, 30000);
                alert('å·²å¯åŠ¨è‡ªåŠ¨åˆ·æ–° (æ¯ 30 ç§’)');
                refreshData();
            }
        }
        
        // ç›‘å¬æ§åˆ¶å˜åŒ–
        document.getElementById('time-range').addEventListener('change', refreshData);
        document.getElementById('limit').addEventListener('change', refreshData);
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', refreshData);
    </script>
</body>
</html>
